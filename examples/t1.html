<html>
  <head>
    <meta charset="utf-8">
    <title>Dev Example — Networked-Aframe</title>
    <meta name="description" content="Dev Example — Networked-Aframe">

    <script src="https://aframe.io/releases/1.0.3/aframe.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"</script>
    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
    <script src="/build.js"></script>
    <script>window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')</script>

    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.5/dist/aframe-particle-system-component.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>

    <script>

AFRAME.registerComponent('test-networked-video-source', {
    init: function() {
        NAF.connection.onConnect(function() {
            navigator.mediaDevices.getUserMedia({audio: true, video: true}).then(video_stream => {
                var local_video_stream = video_stream;
                NAF.connection.adapter.setLocalMediaStream(local_video_stream);
            });
        });
    }
});

AFRAME.registerComponent('test-networked-video-sink', {

    init: function() {
        this.stream = null;
        this._setVideoStream = this._setVideoStream.bind(this);
        NAF.utils.getNetworkedEntity(this.el).then((networkedEl) => {

            const ownerId = networkedEl.components.networked.data.owner;
            console.log('new network entity with ownerId', ownerId);
            if (ownerId) {
                NAF.connection.adapter.getMediaStream(ownerId, 'video')
                    .then(this._setVideoStream)
                    .catch((e) => console.log(`Error getting media stream for ${ownerId}`, e));
            }
        });
    },
remove: function() {
    console.log('ha ha ha ha ha');
    if (this.testEl)
    {
        this.testEl.remove();
        this.testEl = undefined;
    }
    if (this.videoEl)
    {
        this.videoEl.remove();
    }
    this.el.setAttribute('material', "color: yellow");
},

 _buildVideoElement(stream) {
    let videoEl = document.createElement('VIDEO');
    videoEl.setAttribute('playsinline', '');
    videoEl.setAttribute('webkit-playsinline', '');
    videoEl.autoplay = true;
    videoEl.preload = 'auto';
    videoEl.crossOrigin = 'anonymous';
    videoEl.srcObject = stream;
    return videoEl;
 },
 _setVideoStream(newStream) {
        if (this.videoEl) {
               this.videoEl.remove(); 
        }
        if (newStream != this.stream) {
            if (this.stream) {
                this.stream.disconnect();
            }
            let videoEl;
            if (newStream) {
                videoEl = this._buildVideoElement(newStream);
                this.el.sceneEl.appendChild(videoEl);
    
                var promise = videoEl.play();
                var self = this;
                promise.then(function(){
                    self.el.setAttribute('material', {src: videoEl});
                }).catch(function(error) {
                    console.log('rats ' + error);
                });

                let test_div = document.querySelector("#test-video-div");
                if (test_div) {
                    this.testEl = this._buildVideoElement(newStream);
                    test_div.appendChild(this.testEl);
                }

            }
            this.stream = newStream;
            this.videoEl = videoEl;
        }
    }
});

    </script>



  </head>
  <body>

    <div id="test-video-div" style="height:200px; position: relative;"> 
    </div>

    <div id="scene-div" style="position: relative">
    <a-scene id=sceny embedded networked-scene="
      serverURL: wss://thewindmillfactoryfloor.com:4443; 
      room: t1;
      debug: true;
      adapter: nwclientapi;
      audio: true;
    ">


<a-assets>

<img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
<img id="sky" src="https://i.imgur.com/WqlqEkq.jpg" crossorigin="anonymous" />


    <template id="avatar-template">                                                                                           <a-entity class="avatar">
            <a-box class="head"
              scale="0.45 0.5 0.4"
                test-networked-video-sink
              >
              </a-box>
            </a-entity>
          </a-entity>
      </template>

</a-assets>

    <a-entity id="player"
        networked="template:#avatar-template;attachTemplateToLocal:false;"
        camera
        position="0 0 0"
        spawn-in-circle="radius:3"
        wasd-controls look-controls
        test-networked-video-source
        >
        <a-sphere class="head"
          visible="false"
          random-color
        ></a-sphere>
      </a-entity>

       <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
       <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>
 
       <a-sky src="#sky" rotation="0 -90 0"></a-sky>


      <a-entity position="0 0 0"
        geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
        material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

    </a-scene>
    </div>

    <script>
      NAF.schemas.add({
        template: '#avatar-template',
        components: [
          'position',
          'rotation'
        ]
      });

    var TestState = function()
    {
        this.speed = 0;
        this.showBall = true;
    }

    function jumpToTarget(target_id) {
        let player = document.querySelector('#player'); 
        let target = document.querySelector(target_id); 
        player.setAttribute('position', target.object3D.position);

    }
    function jumpToBlue() {
        jumpToTarget('#blue-box');
    }

    function lookAtBlue() {
        let player = document.querySelector('#player'); 
        let pmatrix = player.object3D.matrix;
        let target = document.querySelector('#blue-box'); 

        let lookat = new THREE.Matrix4();
        lookat.lookAt(player.object3D.position, target.object3D.position, new THREE.Vector3(0,1,0));
        let euler = new THREE.Euler();
        euler.setFromRotationMatrix(lookat);

          
        // create second camera and set it as active 
        var camera = document.createElement('a-camera');
        player.appendChild(camera);
        camera.object3D.rotation = euler;
        camera.setAttribute('camera', 'active', true);
    

        player.setAttribute('rotation', euler);
    }

    function spawn10boxes() {
        let min = -10;
        let max = 10;
        var startx = min + Math.random()*(max-min);
        var starty = min + Math.random()*(max-min);
        for (i = 0; i < 10; i++)
        {
            var box = document.createElement('a-box');
            box.object3D.position.set((startx + i)*2, 0, starty*20);
            document.querySelector('a-scene').appendChild(box);
        }
    }

    function kill10boxes() {
        var matches = document.querySelectorAll("a-box");
        let killcount = Math.min(10, matches.length);
        for (let i = 0; i < killcount; i++)
        {
            matches[i].remove();
        } 
    }

    function dumpVideoNodes() {
        var matches = document.querySelectorAll("video");
        for (let i = 0; i < matches.length; i++)
        {
            console.log(matches[i]);
        }
    }

    window.onload = function() {
        var test_state = new TestState();
        var gui = new dat.GUI();
        var obj = { start:function(){ console.log("started") }};
/*
        gui.add(obj,'start').name('[START]');
        gui.add({spawn10:spawn10boxes}, 'spawn10');
        gui.add({kill10:kill10boxes}, 'kill10');
        gui.add({dumpVideoNodes:dumpVideoNodes}, 'dumpVideoNodes');
        gui.add({jumpToBlue:jumpToBlue}, 'jumpToBlue');
        gui.add({lookAtBlue:lookAtBlue}, 'lookAtBlue');
        gui.add(test_state, 'showBall');
*/
    }


      // Called by Networked-Aframe when connected to server
      function onConnect () {
        console.log("onConnect", new Date());
      }
    </script>
  </body>
</html>
