<html>
  <head>
    <meta charset="utf-8">
    <title>Dev Example — Networked-Aframe</title>
    <meta name="description" content="Dev Example — Networked-Aframe">

    <script src="https://aframe.io/releases/1.0.3/aframe.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"</script>
    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
    <script src="/build.js"></script>
    <script>window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')</script>

    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.5/dist/aframe-particle-system-component.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>

    <script>

AFRAME.registerComponent('test-networked-video-source', {
    init: function() {
        NAF.connection.onConnect(function() {
            navigator.mediaDevices.getUserMedia({audio: true, video: true}).then(video_stream => {
                var local_video_stream = video_stream;
                NAF.connection.adapter.setLocalMediaStream(local_video_stream);
            });
        });
    }
});

AFRAME.registerComponent('test-networked-video-sink', {

    init: function() {
        this.stream = null;
        this._setVideoStream = this._setVideoStream.bind(this);
        NAF.utils.getNetworkedEntity(this.el).then((networkedEl) => {

            const ownerId = networkedEl.components.networked.data.owner;
            console.log('new network entity with ownerId', ownerId);
            if (ownerId) {
                NAF.connection.adapter.getMediaStream(ownerId, 'video')
                    .then(this._setVideoStream)
                    .catch((e) => console.log(`Error getting media stream for ${ownerId}`, e));
            }
        });
    },

 _setVideoStream(newStream) {
        if (newStream != this.stream) {
            if (this.stream) {
                this.stream.disconnect();
            }
            if (newStream) {
                this.videoEl = document.createElement('VIDEO');
                this.el.sceneEl.appendChild(this.videoEl);
                this.videoEl.setAttribute('playsinline', '');
                this.videoEl.setAttribute('webkit-playsinline', '');
                this.videoEl.autoplay = true;
                this.videoEl.preload = 'auto';
                this.videoEl.crossOrigin = 'anonymous';

                this.videoEl.srcObject = newStream;
                var promise = this.videoEl.play();
                console.log(promise);

                console.log('el was', this.el);

                var self = this;
                promise.then(function(){
                    console.log('ya');
                    console.log('el is', self.el);
                    console.log('this is', this);
                    self.el.setAttribute('material', {src: self.videoEl});
                }).catch(function(error) {
                    console.log('rats ' + error);
                });
            }
            this.stream = newStream;
        }
    }
});

    </script>



  </head>
  <body>

    <a-scene id=sceny networked-scene="
      serverURL: wss://thewindmillfactoryfloor.com:4443; 
      room: t1;
      debug: true;
      adapter: nwclientapi;
      audio: true;
    ">

<a-box position="-1 0.5 -3" rotation="0 45 0" shadow></a-box>

<a-assets>

<img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
<img id="sky" src="https://i.imgur.com/WqlqEkq.jpg" crossorigin="anonymous" />


    <template id="avatar-template">                                                                                           <a-entity class="avatar">
            <a-box class="head"
              scale="0.45 0.5 0.4"
                test-networked-video-sink
              >
              </a-box>
            </a-entity>
          </a-entity>
      </template>

</a-assets>

    <a-entity id="player"
        networked="template:#avatar-template;attachTemplateToLocal:false;"
        camera
        position="0 1.6 0"
        spawn-in-circle="radius:3"
        wasd-controls look-controls
        test-networked-video-source
        >
        <a-sphere class="head"
          visible="false"
          random-color
        ></a-sphere>
      </a-entity>


      <a-entity position="0 0 0"
        geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
        material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

      <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
      <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>

      <a-sky src="#sky" rotation="0 -90 0"></a-sky>
    </a-scene>

    <script>
      NAF.schemas.add({
        template: '#avatar-template',
        components: [
          'position',
          'rotation'
        ]
      });

    var TestState = function()
    {
        this.speed = 0;
        this.showBall = true;
    }

    function spawn10boxes() {
        let min = -10;
        let max = 10;
        var startx = min + Math.random()*(max-min);
        var starty = min + Math.random()*(max-min);
        for (i = 0; i < 10; i++)
        {
            var box = document.createElement('a-box');
            box.object3D.position.set((startx + i)*2, 0, starty*20);
            document.querySelector('a-scene').appendChild(box);
        }
    }

    function kill10boxes() {
        var matches = document.querySelectorAll("a-box");
        let killcount = Math.min(10, matches.length);
        for (let i = 0; i < killcount; i++)
        {
            matches[i].remove();
        } 
    }

    function dumpVideoNodes() {
        var matches = document.querySelectorAll("video");
        for (let i = 0; i < matches.length; i++)
        {
            console.log(matches[i]);
        }
    }

    window.onload = function() {
        var test_state = new TestState();
        var gui = new dat.GUI();
        var obj = { start:function(){ console.log("started") }};
        gui.add(obj,'start').name('[START]');
        gui.add({spawn10:spawn10boxes}, 'spawn10');
        gui.add({kill10:kill10boxes}, 'kill10');
        gui.add({dumpVideoNodes:dumpVideoNodes}, 'dumpVideoNodes');
        gui.add(test_state, 'showBall');
    }


    

      // Called by Networked-Aframe when connected to server
      function onConnect () {
        console.log("onConnect", new Date());
      }
    </script>
  </body>
</html>
